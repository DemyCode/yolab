name: Deploy YoLab Server

on:
  workflow_dispatch:
    inputs:
      target_host:
        description: "Target server IP or hostname"
        required: true
        type: string
      domain:
        description: "Domain name"
        required: true
        type: string
      repo_url:
        description: "Git repository URL"
        required: false
        default: "https://github.com/${{ github.repository }}"
        type: string
  push:
    branches: [main, master]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ inputs.target_host }} >> ~/.ssh/known_hosts || true

      - run: |
          if [ -z "${{ secrets.POSTGRES_PASSWORD }}" ]; then
            echo "Error: POSTGRES_PASSWORD secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.IPV6_SUBNET_BASE }}" ]; then
            echo "Error: IPV6_SUBNET_BASE secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.FRPS_SERVER_IPV6 }}" ]; then
            echo "Error: FRPS_SERVER_IPV6 secret is not set"
            exit 1
          fi

      - run: |
          cd deployment/nixos

          sed -e "s|REPLACE_REPO_URL|${{ inputs.repo_url }}|g" \
              -e "s|REPLACE_DOMAIN|${{ inputs.domain }}|g" \
              -e "s|REPLACE_POSTGRES_DB|${{ secrets.POSTGRES_DB }}|g" \
              -e "s|REPLACE_POSTGRES_USER|${{ secrets.POSTGRES_USER }}|g" \
              -e "s|REPLACE_POSTGRES_PASSWORD|${{ secrets.POSTGRES_PASSWORD }}|g" \
              -e "s|REPLACE_IPV6_SUBNET_BASE|${{ secrets.IPV6_SUBNET_BASE }}|g" \
              -e "s|REPLACE_FRPS_SERVER_IPV6|${{ secrets.FRPS_SERVER_IPV6 }}|g" \
              -i all-in-one.nix

      - run: |
          nix build ".#nixosConfigurations.yolab-server.config.system.build.toplevel" --print-build-logs

      - env:
          NIX_SSHOPTS: "-i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new"
        run: |
          nix run github:nix-community/nixos-anywhere -- \
            --flake ".#yolab-server" \
            --ssh-option "IdentityFile=~/.ssh/deploy_key" \
            --ssh-option "StrictHostKeyChecking=accept-new" \
            "root@${{ inputs.target_host }}"

      - if: success()
        run: |
          sleep 30

          for i in {1..10}; do
            if curl -f "http://${{ inputs.target_host }}:5000/health"; then
              echo "Backend is healthy!"
              break
            fi
            echo "Waiting for backend... (attempt $i/10)"
            sleep 10
          done

      - if: always()
        run: |
          rm -f ~/.ssh/deploy_key
