# Configuration Management Guide

## Overview

YoLab uses a TOML-based configuration system that separates secrets and deployment settings from code. This approach provides:

- **Security**: Secrets are stored in gitignored files
- **Simplicity**: Single configuration file with all settings
- **Flexibility**: Easy to edit and validate
- **Consistency**: Same format for Terraform and manual deployments
- **Type Safety**: Terraform generates TOML using the filemanager provider

## Configuration File Location

```
deployment/nixos/ignored/config.toml
```

This file is:
- ✅ Gitignored (safe for secrets)
- ✅ Auto-generated by Terraform
- ✅ Can be manually created/edited
- ✅ Required for NixOS deployment

## Configuration Structure

```toml
[server]
hostname = "yolab-server"
domain = "example.com"
repo_url = "https://github.com/yourusername/yolab.git"

[ssh]
public_key = "ssh-ed25519 AAAA..."
key_name = "yolab-deployment-key"

[database]
db_name = "frp_services"
db_user = "frp_user"
db_password = "your-secure-password"

[network]
ipv6_subnet_base = "2001:db8::1:0:0:0"
frps_server_ipv6 = "2001:db8::1"
frps_bind_port = 7000
auth_plugin_addr = "127.0.0.1:5000"

[frps]
enable = true

[services]
enable = true
api_host = "0.0.0.0"
api_port = 5000
auto_update = true
open_firewall = true
```

## Deployment Methods

### Method 1: Terraform (Automatic)

Terraform automatically generates `config.toml` using the `filemanager_toml_file` resource:

```bash
cd deployment/terraform

# Configure variables
cp terraform.tfvars.example terraform.tfvars
vim terraform.tfvars

# Deploy (automatically creates config.toml with proper TOML structure)
terraform init
terraform apply
```

The `filemanager` provider ensures:
- ✅ **Valid TOML syntax** - No escaping issues
- ✅ **Type-safe generation** - Proper boolean/integer handling  
- ✅ **Structured data** - Native HCL to TOML conversion
- ✅ **Idempotent updates** - Only changes when values change

### Method 2: Manual Configuration

Create the configuration file manually before deployment:

```bash
cd deployment/nixos/ignored

# Copy example
cp config.toml.example config.toml

# Edit with your values
vim config.toml

# Deploy using the script
cd ../../scripts
TARGET_HOST=192.168.1.100 \
POSTGRES_PASSWORD=secret \
IPV6_SUBNET_BASE=2001:db8::1:0:0:0 \
FRPS_SERVER_IPV6=2001:db8::1 \
DOMAIN=yourdomain.com \
./deploy-all-in-one.sh
```

### Method 3: Script Auto-Generation

The deployment script can generate `config.toml` from environment variables:

```bash
cd deployment/scripts

# Set all required environment variables
export TARGET_HOST="192.168.1.100"
export SSH_PUBLIC_KEY="$(cat ~/.ssh/id_ed25519.pub)"
export POSTGRES_PASSWORD="secure-password"
export IPV6_SUBNET_BASE="2001:db8::1:0:0:0"
export FRPS_SERVER_IPV6="2001:db8::1"
export DOMAIN="yourdomain.com"

# Deploy (automatically creates config.toml)
./deploy-all-in-one.sh
```

## Configuration Validation

The NixOS configuration **strictly validates** the TOML file during build:

```bash
# Build configuration (validates TOML)
nix build .#nixosConfigurations.yolab-server.config.system.build.toplevel
```

**Important:** All configuration values are **required**. There are no default values. If a required value is missing, the build will fail with a clear error message indicating which field is missing.

This "fail-fast" approach ensures:
- ✅ **No silent failures** - Missing config is caught immediately
- ✅ **Clear error messages** - You know exactly what's wrong
- ✅ **Type safety** - Nix validates the TOML structure
- ✅ **Predictable behavior** - No surprises from default values

### Example Error Messages

**Missing config file:**
```
error: Configuration file not found: /path/to/deployment/nixos/ignored/config.toml

Please create deployment/nixos/ignored/config.toml with your deployment settings.
```

**Missing required field:**
```
error: attribute 'public_key' missing
       at deployment/nixos/all-in-one.nix:63:5
```

**Invalid TOML syntax:**
```
error: TOML parsing error at line 10: invalid escape sequence
```

## Editing Configuration

### After Terraform Deployment

If you deployed with Terraform and want to edit the configuration:

```bash
cd deployment/nixos/ignored

# Edit the auto-generated config
vim config.toml

# Rebuild the system (if server is already deployed)
ssh root@your-server "cd /etc/nixos && nixos-rebuild switch"
```

### Before Manual Deployment

```bash
cd deployment/nixos/ignored

# Create from example if not exists
[[ ! -f config.toml ]] && cp config.toml.example config.toml

# Edit configuration
vim config.toml

# Validate by building
cd ../../..
nix build .#nixosConfigurations.yolab-server.config.system.build.toplevel
```

## Configuration Fields Reference

### [server]
- `hostname`: Server hostname (default: "yolab-server")
- `domain`: Your domain name for the service
- `repo_url`: Git repository URL for pulling code

### [ssh]
- `public_key`: SSH public key for root access (required)
- `key_name`: Name for SSH key in Hetzner Cloud (optional)

### [database]
- `db_name`: PostgreSQL database name
- `db_user`: PostgreSQL username
- `db_password`: PostgreSQL password (keep secure!)

### [network]
- `ipv6_subnet_base`: IPv6 subnet for client allocation
- `frps_server_ipv6`: FRP server's IPv6 address
- `frps_bind_port`: Port for FRP server (default: 7000)
- `auth_plugin_addr`: Address of auth plugin (default: "127.0.0.1:5000")

### [frps]
- `enable`: Enable FRP server (true/false)

### [services]
- `enable`: Enable backend services (true/false)
- `api_host`: API host binding (default: "0.0.0.0")
- `api_port`: API port (default: 5000)
- `auto_update`: Auto-update from git (true/false)
- `open_firewall`: Open firewall ports (true/false)

## Troubleshooting

### Error: Configuration file not found

```
Please create deployment/nixos/ignored/config.toml
```

**Solution:**
```bash
cp deployment/nixos/ignored/config.toml.example deployment/nixos/ignored/config.toml
vim deployment/nixos/ignored/config.toml
```

### Error: Invalid TOML syntax

**Solution:** Validate TOML syntax:
```bash
# Using Python (built-in tomllib in Python 3.11+)
python3 -c "import tomllib; tomllib.load(open('deployment/nixos/ignored/config.toml', 'rb'))"
```

### SSH Key Not Working

Verify your SSH public key is correctly set in `config.toml`:
```bash
grep "public_key" deployment/nixos/ignored/config.toml
```

Should show your full SSH public key starting with `ssh-ed25519` or `ssh-rsa`.

## Security Best Practices

1. **Never commit config.toml**: It's gitignored by default
2. **Use strong passwords**: Generate secure database passwords
3. **Rotate SSH keys**: Update `ssh.public_key` when needed
4. **Limit access**: Only share config.toml with authorized personnel
5. **Backup safely**: Keep encrypted backups of config.toml

## Workflow Comparison

### Old Approach (sed-based)
❌ Hard to read and maintain
❌ Error-prone escaping
❌ Difficult to validate
❌ Scattered across multiple files

### New Approach (TOML-based)
✅ Clean, readable configuration
✅ Structured and type-safe
✅ Easy to validate
✅ Single source of truth
✅ Works with Terraform and manual deployments
